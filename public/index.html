<!DOCTYPE html>
<!-- Declara o tipo de documento como HTML5 -->
<html lang="pt">
<!-- Define o idioma do documento como português -->
<head>
  <!-- Define a codificação de caracteres como UTF-8 para suportar caracteres especiais -->
  <meta charset="UTF-8">
  <!-- Configura a viewport para responsividade em dispositivos móveis -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Define o título da página exibido na aba do navegador -->
  <title>Agenda de Contatos</title>
  <!-- Inclui o CSS do Bootstrap 5.3.3 via CDN para estilização e layout -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Inclui o arquivo estilo.css local para estilização personalizada (ex.: gradientes, sombras) -->
  <link rel="stylesheet" href="estilo.css">
</head>
<body>
  <!-- Container principal com margem superior de 5 unidades (Bootstrap) -->
  <div class="container mt-5">
    <!-- Título principal da agenda, centralizado com margem inferior de 4 unidades -->
    <h1 class="text-center mb-4">Agenda de Contatos</h1>
    <!-- Seção de autenticação (login, registro, recuperação de senha), exibida por padrão -->
    <div id="authSection">
      <!-- Linha Bootstrap para centralizar o conteúdo -->
      <div class="row justify-content-center">
        <!-- Coluna com largura média de 6 unidades para centralizar o formulário -->
        <div class="col-md-6">
          <!-- Card Bootstrap para o formulário de login -->
          <div class="card">
            <!-- Corpo do card com padding interno -->
            <div class="card-body">
              <!-- Título do card, centralizado -->
              <h3 class="card-title text-center">Login</h3>
              <!-- Div para exibir erros de login, oculta por padrão -->
              <div id="loginError" class="alert alert-danger d-none"></div>
              <!-- Formulário de login -->
              <form id="loginForm">
                <!-- Campo de nome com rótulo e validação -->
                <div class="mb-3">
                  <label for="name" class="form-label">Nome</label>
                  <input type="text" class="form-control" id="name" placeholder="Digite seu nome completo" title="Insira o nome usado no registro" required>
                </div>
                <!-- Campo de senha com rótulo e validação -->
                <div class="mb-3">
                  <label for="password" class="form-label">Senha</label>
                  <input type="password" class="form-control" id="password" placeholder="Digite sua senha" title="Senha com pelo menos 6 caracteres" required>
                </div>
                <!-- Campo de seleção de função (usuário ou administrador) -->
                <div class="mb-3">
                  <label for="loginRole" class="form-label">Acessar como</label>
                  <select class="form-select" id="loginRole" title="Selecione sua função" required>
                    <option value="" disabled selected>Escolha uma função</option>
                    <option value="user">Usuário</option>
                    <option value="admin">Administrador</option>
                  </select>
                </div>
                <!-- Botão de envio do formulário, ocupando toda a largura -->
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
              </form>
              <!-- Links para recuperação de senha e registro -->
              <p class="mt-3 text-center">
                <a href="#" id="forgotPasswordLink">Esqueceu a senha?</a> | 
                <a href="#" id="registerLink">Registrar-se</a>
              </p>
            </div>
          </div>
          <!-- Card para o formulário de registro, oculta por padrão -->
          <div class="card mt-3 d-none" id="registerFormDiv">
            <!-- Corpo do card com padding interno -->
            <div class="card-body">
              <!-- Título do card, centralizado -->
              <h3 class="card-title text-center">Registro</h3>
              <!-- Div para exibir erros de registro, oculta por padrão -->
              <div id="registerError" class="alert alert-danger d-none"></div>
              <!-- Formulário de registro -->
              <form id="registerForm">
                <!-- Campo de nome com rótulo e validação -->
                <div class="mb-3">
                  <label for="regName" class="form-label">Nome</label>
                  <input type="text" class="form-control" id="regName" placeholder="Digite seu nome completo" title="Insira seu nome completo" required>
                </div>
                <!-- Campo de email com rótulo e validação -->
                <div class="mb-3">
                  <label for="regEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="regEmail" placeholder="Digite seu email" title="Insira um email válido" required>
                </div>
                <!-- Campo de senha com rótulo, validação e comprimento mínimo -->
                <div class="mb-3">
                  <label for="regPassword" class="form-label">Senha</label>
                  <input type="password" class="form-control" id="regPassword" placeholder="Crie uma senha (mín. 6 caracteres)" title="Senha com pelo menos 6 caracteres" minlength="6" required>
                </div>
                <!-- Campo de data de nascimento com rótulo e validação -->
                <div class="mb-3">
                  <label for="regDate" class="form-label">Data de Nascimento</label>
                  <input type="date" class="form-control" id="regDate" title="Selecione sua data de nascimento" required>
                </div>
                <!-- Campo de data especial com rótulo e validação -->
                <div class="mb-3">
                  <label for="regSpecialDate" class="form-label">Data Especial</label>
                  <input type="date" class="form-control" id="regSpecialDate" title="Selecione uma data especial" required>
                </div>
                <!-- Campo de seleção de função (usuário ou administrador) -->
                <div class="mb-3">
                  <label for="regRole" class="form-label">Registrar como</label>
                  <select class="form-select" id="regRole" title="Selecione sua função" required>
                    <option value="" disabled selected>Escolha uma função</option>
                    <option value="user">Usuário</option>
                    <option value="admin">Administrador</option>
                  </select>
                </div>
                <!-- Botão de envio do formulário, ocupando toda a largura -->
                <button type="submit" class="btn btn-primary w-100">Registrar</button>
              </form>
              <!-- Link para voltar ao login -->
              <p class="mt-3 text-center"><a href="#" id="backToLoginLink">Voltar ao Login</a></p>
            </div>
          </div>
          <!-- Card para o formulário de recuperação de senha, oculta por padrão -->
          <div class="card mt-3 d-none" id="forgotPasswordFormDiv">
            <!-- Corpo do card com padding interno -->
            <div class="card-body">
              <!-- Título do card, centralizado -->
              <h3 class="card-title text-center">Recuperar Senha</h3>
              <!-- Div para exibir erros de recuperação, oculta por padrão -->
              <div id="forgotError" class="alert alert-danger d-none"></div>
              <!-- Formulário de recuperação de senha -->
              <form id="forgotPasswordForm">
                <!-- Campo de email com rótulo e validação -->
                <div class="mb-3">
                  <label for="forgotEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="forgotEmail" placeholder="Digite seu email" title="Insira o email registrado" required>
                </div>
                <!-- Botão de envio do formulário, ocupando toda a largura -->
                <button type="submit" class="btn btn-primary w-100">Enviar Link de Recuperação</button>
              </form>
              <!-- Link para voltar ao login -->
              <p class="mt-3 text-center"><a href="#" id="backToLoginLink2">Voltar ao Login</a></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Seção da agenda, oculta por padrão até o login -->
    <div id="agendaSection" class="d-none">
      <!-- Cabeçalho com mensagem de boas-vindas e botões -->
      <div class="d-flex justify-content-between mb-3">
        <!-- Mensagem de boas-vindas personalizada com o nome do usuário -->
        <h3 id="welcomeMessage">Bem-vindo!</h3>
        <!-- Botões de navegação (chat e logout) -->
        <div>
          <!-- Link para a página de chat (chat.html) -->
          <a href="chat.html" class="btn btn-info">Chat</a>
          <!-- Botão para sair, limpando o localStorage -->
          <button id="logoutBtn" class="btn btn-danger">Sair</button>
        </div>
      </div>
      <!-- Seção de administração, visível apenas para administradores -->
      <div id="adminSection" class="d-none">
        <!-- Título da seção de gerenciamento de usuários -->
        <h4>Gerenciar Usuários</h4>
        <!-- Botão para abrir o modal de adicionar usuário -->
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">Adicionar Usuário</button>
        <!-- Tabela para listar usuários -->
        <table class="table table-bordered">
          <!-- Cabeçalho da tabela -->
          <thead>
            <tr>
              <th>Nome</th>
              <th>Email</th>
              <th>Função</th>
              <th>Ações</th>
            </tr>
          </thead>
          <!-- Corpo da tabela, preenchido dinamicamente -->
          <tbody id="usersTable"></tbody>
        </table>
      </div>
      <!-- Título da seção de contatos -->
      <h4>Seus Contatos</h4>
      <!-- Botão para abrir o modal de adicionar contato -->
      <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#contactModal">Adicionar Contato</button>
      <!-- Tabela para listar contatos -->
      <table class="table table-bordered">
        <!-- Cabeçalho da tabela -->
        <thead>
          <tr>
            <th>Nome</th>
            <th>Telefone</th>
            <th>Email</th>
            <th>Categoria</th>
            <th>Data Especial</th>
            <th>Ações</th>
          </tr>
        </thead>
        <!-- Corpo da tabela, preenchido dinamicamente -->
        <tbody id="contactsTable"></tbody>
      </table>
      <!-- Seção de relatórios, visível apenas para administradores -->
      <div id="reportsSection" class="d-none mt-4">
        <!-- Título da seção de relatórios -->
        <h4>Relatórios</h4>
        <!-- Conteúdo dos relatórios, preenchido dinamicamente -->
        <div id="reportsContent"></div>
      </div>
    </div>
  </div>

  <!-- Modal para adicionar ou editar contatos -->
  <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <!-- Diálogo do modal -->
    <div class="modal-dialog">
      <!-- Conteúdo do modal -->
      <div class="modal-content">
        <!-- Cabeçalho do modal -->
        <div class="modal-header">
          <!-- Título do modal, alterado dinamicamente (Adicionar/Editar) -->
          <h5 class="modal-title" id="contactModalLabel">Adicionar Contato</h5>
          <!-- Botão para fechar o modal -->
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <!-- Corpo do modal -->
        <div class="modal-body">
          <!-- Formulário para adicionar/editar contato -->
          <form id="contactForm">
            <!-- Campo de nome do contato -->
            <div class="mb-3">
              <label for="contactName" class="form-label">Nome</label>
              <input type="text" class="form-control" id="contactName" title="Insira o nome do contato" required>
            </div>
            <!-- Campo de telefone com validação específica -->
            <div class="mb-3">
              <label for="contactPhone" class="form-label">Telefone</label>
              <input type="text" class="form-control" id="contactPhone" placeholder="+258xxxxxxxxx" title="Telefone com +258 e 9 dígitos" required>
            </div>
            <!-- Campo de email (opcional) -->
            <div class="mb-3">
              <label for="contactEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="contactEmail" title="Email opcional do contato">
            </div>
            <!-- Campo de categoria do contato -->
            <div class="mb-3">
              <label for="contactCategory" class="form-label">Categoria</label>
              <select class="form-select" id="contactCategory" title="Selecione a categoria do contato" required>
                <option value="Família">Família</option>
                <option value="Trabalho">Trabalho</option>
                <option value="Amigos">Amigos</option>
                <option value="Clientes">Clientes</option>
              </select>
            </div>
            <!-- Campo de data especial (opcional) -->
            <div class="mb-3">
              <label for="contactSpecialDate" class="form-label">Data Especial</label>
              <input type="date" class="form-control" id="contactSpecialDate" title="Data especial opcional">
            </div>
            <!-- Campo oculto para armazenar o ID do contato (usado na edição) -->
            <input type="hidden" id="contactId">
            <!-- Botão de envio do formulário -->
            <button type="submit" class="btn btn-primary w-100">Salvar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para adicionar usuário (apenas administradores) -->
  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <!-- Diálogo do modal -->
    <div class="modal-dialog">
      <!-- Conteúdo do modal -->
      <div class="modal-content">
        <!-- Cabeçalho do modal -->
        <div class="modal-header">
          <!-- Título do modal -->
          <h5 class="modal-title" id="addUserModalLabel">Adicionar Usuário</h5>
          <!-- Botão para fechar o modal -->
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <!-- Corpo do modal -->
        <div class="modal-body">
          <!-- Formulário para adicionar usuário -->
          <form id="addUserForm">
            <!-- Campo de nome do usuário -->
            <div class="mb-3">
              <label for="addName" class="form-label">Nome</label>
              <input type="text" class="form-control" id="addName" placeholder="Digite o nome completo" title="Insira o nome completo" required>
            </div>
            <!-- Campo de email do usuário -->
            <div class="mb-3">
              <label for="addEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="addEmail" placeholder="Digite o email" title="Insira um email válido" required>
            </div>
            <!-- Campo de senha do usuário -->
            <div class="mb-3">
              <label for="addPassword" class="form-label">Senha</label>
              <input type="password" class="form-control" id="addPassword" placeholder="Crie uma senha (mín. 6 caracteres)" title="Senha com pelo menos 6 caracteres" minlength="6" required>
            </div>
            <!-- Campo de data de nascimento do usuário -->
            <div class="mb-3">
              <label for="addDate" class="form-label">Data de Nascimento</label>
              <input type="date" class="form-control" id="addDate" title="Selecione a data de nascimento" required>
            </div>
            <!-- Campo de data especial do usuário -->
            <div class="mb-3">
              <label for="addSpecialDate" class="form-label">Data Especial</label>
              <input type="date" class="form-control" id="addSpecialDate" title="Selecione uma data especial" required>
            </div>
            <!-- Campo de seleção de função do usuário -->
            <div class="mb-3">
              <label for="addRole" class="form-label">Função</label>
              <select class="form-select" id="addRole" title="Selecione a função" required>
                <option value="" disabled selected>Escolha uma função</option>
                <option value="user">Usuário</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <!-- Botão de envio do formulário -->
            <button type="submit" class="btn btn-primary w-100">Adicionar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Inclui o JavaScript do Bootstrap 5.3.3 para modais e outros componentes -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Script JavaScript para gerenciar a lógica da página -->
  <script>
    // Função para exibir mensagens de erro em uma div específica
    const showError = (elementId, message) => {
      const errorDiv = document.getElementById(elementId);
      errorDiv.textContent = message;
      errorDiv.classList.remove('d-none');
      setTimeout(() => errorDiv.classList.add('d-none'), 5000);
    };

    // Função para alternar entre seções de autenticação e agenda
    function toggleSections() {
      // Recupera o token e os dados do usuário do localStorage
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));
      // Seleciona as seções de autenticação e agenda
      const authSection = document.getElementById('authSection');
      const agendaSection = document.getElementById('agendaSection');
      // Verifica se o usuário está autenticado
      if (token && user) {
        // Oculta a seção de autenticação e exibe a seção de agenda
        authSection.classList.add('d-none');
        agendaSection.classList.remove('d-none');
        // Personaliza a mensagem de boas-vindas com o nome do usuário
        document.getElementById('welcomeMessage').textContent = `Bem-vindo, ${user.name}!`;
        // Para administradores, exibe seções de gerenciamento de usuários e relatórios
        if (user.role === 'admin') {
          document.getElementById('adminSection').classList.remove('d-none');
          document.getElementById('reportsSection').classList.remove('d-none');
          loadUsers();
          loadReports();
        }
        // Carrega os contatos do usuário
        loadContacts();
      } else {
        // Exibe a seção de autenticação e oculta a seção de agenda
        authSection.classList.remove('d-none');
        agendaSection.classList.add('d-none');
      }
    }

    // Executa a alternância de seções ao carregar a página
    toggleSections();

    // Evento para exibir o formulário de registro
    document.getElementById('registerLink').addEventListener('click', (e) => {
      e.preventDefault();
      // Oculta o formulário de login
      document.getElementById('loginForm').parentElement.parentElement.classList.add('d-none');
      // Exibe o formulário de registro
      document.getElementById('registerFormDiv').classList.remove('d-none');
    });

    // Evento para exibir o formulário de recuperação de senha
    document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
      e.preventDefault();
      // Oculta o formulário de login
      document.getElementById('loginForm').parentElement.parentElement.classList.add('d-none');
      // Exibe o formulário de recuperação de senha
      document.getElementById('forgotPasswordFormDiv').classList.remove('d-none');
    });

    // Evento para voltar ao formulário de login a partir do registro
    document.getElementById('backToLoginLink').addEventListener('click', (e) => {
      e.preventDefault();
      // Oculta o formulário de registro
      document.getElementById('registerFormDiv').classList.add('d-none');
      // Exibe o formulário de login
      document.getElementById('loginForm').parentElement.parentElement.classList.remove('d-none');
    });

    // Evento para voltar ao formulário de login a partir da recuperação de senha
    document.getElementById('backToLoginLink2').addEventListener('click', (e) => {
      e.preventDefault();
      // Oculta o formulário de recuperação de senha
      document.getElementById('forgotPasswordFormDiv').classList.add('d-none');
      // Exibe o formulário de login
      document.getElementById('loginForm').parentElement.parentElement.classList.remove('d-none');
    });

    // Evento de submissão do formulário de login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // Obtém os valores dos campos
      const name = document.getElementById('name').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('loginRole').value;
      // Validações básicas no lado do cliente
      if (!name) return showError('loginError', 'Por favor, preencha o campo Nome.');
      if (!password) return showError('loginError', 'Por favor, preencha o campo Senha.');
      if (!role) return showError('loginError', 'Por favor, selecione uma função.');
      try {
        // Log para depuração
        console.log('Enviando login:', { name, password, role });
        // Envia solicitação de login para a API
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, password, role })
        });
        const result = await response.json();
        // Log para depuração
        console.log('Resposta do login:', result);
        // Verifica se o login foi bem-sucedido
        if (result.success) {
          // Armazena o token e os dados do usuário no localStorage
          localStorage.setItem('token', result.token);
          localStorage.setItem('user', JSON.stringify(result.user));
          // Recarrega a página para exibir a seção de agenda
          location.reload();
        } else {
          // Exibe mensagem de erro
          showError('loginError', result.message);
        }
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro no login:', e.message);
        showError('loginError', 'Erro ao conectar ao servidor. Verifique se o servidor está rodando.');
      }
    });

    // Evento de submissão do formulário de registro
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // Obtém os valores dos campos
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const date = document.getElementById('regDate').value;
      const specialDate = document.getElementById('regSpecialDate').value;
      const role = document.getElementById('regRole').value;

      // Validações básicas no lado do cliente
      if (!name) return showError('registerError', 'Por favor, preencha o campo Nome.');
      if (!email) return showError('registerError', 'Por favor, preencha o campo Email.');
      if (!email.includes('@')) return showError('registerError', 'Email inválido.');
      if (!password) return showError('registerError', 'Por favor, preencha o campo Senha.');
      if (password.length < 6) return showError('registerError', 'A senha deve ter pelo menos 6 caracteres.');
      if (!date) return showError('registerError', 'Por favor, selecione a Data de Nascimento.');
      if (!specialDate) return showError('registerError', 'Por favor, selecione a Data Especial.');
      if (!role) return showError('registerError', 'Por favor, selecione uma função.');

      try {
        // Log para depuração
        console.log('Enviando registro:', { name, email, password, date, specialDate, role });
        // Envia solicitação de registro para a API
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password, date, specialDate, role })
        });
        const result = await response.json();
        // Log para depuração
        console.log('Resposta do registro:', result);
        // Verifica se o registro foi bem-sucedido
        if (result.success) {
          // Exibe mensagem de sucesso e volta ao login
          alert('Registro bem-sucedido! Faça login.');
          document.getElementById('backToLoginLink').click();
        } else {
          // Exibe mensagem de erro
          showError('registerError', result.message);
        }
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro no registro:', e.message);
        showError('registerError', 'Erro ao conectar ao servidor. Verifique se o servidor está rodando.');
      }
    });

    // Evento de submissão do formulário de recuperação de senha
    document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // Obtém o valor do campo email
      const email = document.getElementById('forgotEmail').value.trim();
      // Validação básica no lado do cliente
      if (!email) return showError('forgotError', 'Por favor, preencha o campo Email.');
      try {
        // Log para depuração
        console.log('Enviando recuperação de senha:', { email });
        // Envia solicitação de recuperação para a API
        const response = await fetch('/api/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const result = await response.json();
        // Log para depuração
        console.log('Resposta da recuperação:', result);
        // Exibe mensagem retornada pela API
        alert(result.message);
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro na recuperação:', e.message);
        showError('forgotError', 'Erro ao conectar ao servidor.');
      }
    });

    // Evento de submissão do formulário de adição de usuário (admin)
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // Obtém os valores dos campos
      const name = document.getElementById('addName').value.trim();
      const email = document.getElementById('addEmail').value.trim();
      const password = document.getElementById('addPassword').value;
      const date = document.getElementById('addDate').value;
      const specialDate = document.getElementById('addSpecialDate').value;
      const role = document.getElementById('addRole').value;

      // Validações básicas no lado do cliente
      if (!name) return alert('Por favor, preencha o campo Nome.');
      if (!email) return alert('Por favor, preencha o campo Email.');
      if (!email.includes('@')) return alert('Email inválido.');
      if (!password) return alert('Por favor, preencha o campo Senha.');
      if (password.length < 6) return alert('A senha deve ter pelo menos 6 caracteres.');
      if (!date) return alert('Por favor, selecione a Data de Nascimento.');
      if (!specialDate) return alert('Por favor, selecione a Data Especial.');
      if (!role) return alert('Por favor, selecione uma função.');

      try {
        // Log para depuração
        console.log('Adicionando usuário:', { name, email, password, date, specialDate, role });
        // Envia solicitação de adição de usuário para a API
        const response = await fetch('/api/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ name, email, password, date, specialDate, role })
        });
        const result = await response.json();
        // Log para depuração
        console.log('Resposta da adição:', result);
        // Verifica se a adição foi bem-sucedida
        if (result.success) {
          // Exibe mensagem de sucesso, atualiza a tabela e fecha o modal
          alert('Usuário adicionado com sucesso!');
          loadUsers();
          bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
          document.getElementById('addUserForm').reset();
        } else {
          // Exibe mensagem de erro
          alert(result.message);
        }
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro ao adicionar usuário:', e.message);
        alert('Erro ao adicionar usuário. Verifique se o servidor está rodando.');
      }
    });

    // Evento para logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      // Remove o token e os dados do usuário do localStorage
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      // Recarrega a página para voltar à seção de autenticação
      location.reload();
    });

    // Função para carregar a lista de usuários (admin)
    async function loadUsers() {
      try {
        // Log para depuração
        console.log('Carregando usuários...');
        // Envia solicitação para obter a lista de usuários
        const response = await fetch('/api/users', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const users = await response.json();
        // Log para depuração
        console.log('Usuários carregados:', users);
        // Seleciona o corpo da tabela de usuários
        const tbody = document.getElementById('usersTable');
        tbody.innerHTML = '';
        // Preenche a tabela com os dados dos usuários
        users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>
              <select onchange="updateRole('${u.id}', this.value)">
                <option value="user" ${u.role === 'user' ? 'selected' : ''}>Usuário</option>
                <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Administrador</option>
              </select>
              <button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro ao carregar usuários:', e.message);
        alert('Erro ao carregar usuários');
      }
    }

    // Função para atualizar a função de um usuário (admin)
    async function updateRole(userId, role) {
      try {
        // Log para depuração
        console.log('Atualizando função:', { userId, role });
        // Envia solicitação para atualizar a função do usuário
        const response = await fetch(`/api/users/${userId}/role`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ role })
        });
        const result = await response.json();
        // Log para depuração
        console.log('Resposta da atualização:', result);
        // Exibe mensagem retornada pela API
        alert(result.message);
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro ao atualizar função:', e.message);
        alert('Erro ao atualizar função');
      }
    }

    // Função para excluir um usuário (admin)
    async function deleteUser(userId) {
      // Confirma a exclusão com o usuário
      if (confirm('Tem certeza que deseja excluir este usuário?')) {
        try {
          // Log para depuração
          console.log('Excluindo usuário:', userId);
          // Envia solicitação para excluir o usuário
          const response = await fetch(`/api/users/${userId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const result = await response.json();
          // Log para depuração
          console.log('Resposta da exclusão:', result);
          // Verifica se a exclusão foi bem-sucedida
          if (result.success) {
            // Exibe mensagem de sucesso e atualiza a tabela
            alert('Usuário excluído');
            loadUsers();
          } else {
            // Exibe mensagem de erro
            alert(result.message);
          }
        } catch (e) {
          // Log e mensagem de erro para falhas de conexão
          console.error('Erro ao excluir usuário:', e.message);
          alert('Erro ao excluir usuário');
        }
      }
    }

    // Função para carregar a lista de contatos
    async function loadContacts() {
      try {
        // Log para depuração
        console.log('Carregando contatos...');
        // Envia solicitação para obter a lista de contatos
        const response = await fetch('/api/contacts', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const contacts = await response.json();
        // Log para depuração
        console.log('Contatos carregados:', contacts);
        // Seleciona o corpo da tabela de contatos
        const tbody = document.getElementById('contactsTable');
        tbody.innerHTML = '';
        // Preenche a tabela com os dados dos contatos
        contacts.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.name}</td>
            <td>${c.phone}</td>
            <td>${c.email || ''}</td>
            <td>${c.category}</td>
            <td>${c.specialDate || ''}</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="editContact('${c.id}')">Editar</button>
              <button class="btn btn-danger btn-sm" onclick="deleteContact('${c.id}')">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro ao carregar contatos:', e.message);
        alert('Erro ao carregar contatos');
      }
    }

    // Função para editar um contato
    async function editContact(id) {
      try {
        // Log para depuração
        console.log('Carregando contato:', id);
        // Envia solicitação para obter os dados do contato
        const response = await fetch(`/api/contacts/${id}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const contact = await response.json();
        // Log para depuração
        console.log('Contato carregado:', contact);
        // Preenche os campos do formulário com os dados do contato
        document.getElementById('contactId').value = contact.id;
        document.getElementById('contactName').value = contact.name;
        document.getElementById('contactPhone').value = contact.phone;
        document.getElementById('contactEmail').value = contact.email;
        document.getElementById('contactCategory').value = contact.category;
        document.getElementById('contactSpecialDate').value = contact.specialDate;
        // Altera o título do modal para edição
        document.getElementById('contactModalLabel').textContent = 'Editar Contato';
        // Exibe o modal
        new bootstrap.Modal(document.getElementById('contactModal')).show();
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro ao carregar contato:', e.message);
        alert('Erro ao carregar contato');
      }
    }

    // Função para excluir um contato
    async function deleteContact(id) {
      // Confirma a exclusão com o usuário
      if (confirm('Tem certeza que deseja excluir este contato?')) {
        try {
          // Log para depuração
          console.log('Excluindo contato:', id);
          // Envia solicitação para excluir o contato
          const response = await fetch(`/api/contacts/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const result = await response.json();
          // Log para depuração
          console.log('Resposta da exclusão:', result);
          // Verifica se a exclusão foi bem-sucedida
          if (result.success) {
            // Exibe mensagem de sucesso e atualiza a tabela
            alert('Contato excluído');
            loadContacts();
          } else {
            // Exibe mensagem de erro
            alert(result.message);
          }
        } catch (e) {
          // Log e mensagem de erro para falhas de conexão
          console.error('Erro ao excluir contato:', e.message);
          alert('Erro ao excluir contato');
        }
      }
    }

    // Evento de submissão do formulário de contato
    document.getElementById('contactForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // Obtém o ID do contato (vazio para novo contato)
      const id = document.getElementById('contactId').value;
      // Obtém o telefone e valida o formato (+258 + 9 dígitos)
      const phone = document.getElementById('contactPhone').value;
      if (!phone.startsWith('+258') || phone.replace('+258', '').length !== 9) {
        alert('Telefone deve começar com +258 e ter 9 dígitos');
        return;
      }
      // Cria o objeto de contato com os dados do formulário
      const contact = {
        name: document.getElementById('contactName').value,
        phone,
        email: document.getElementById('contactEmail').value,
        category: document.getElementById('contactCategory').value,
        specialDate: document.getElementById('contactSpecialDate').value
      };
      try {
        // Log para depuração
        console.log('Salvando contato:', contact);
        // Determina a URL e o método (POST para novo, PUT para edição)
        const url = id ? `/api/contacts/${id}` : '/api/contacts';
        const method = id ? 'PUT' : 'POST';
        // Envia solicitação para salvar o contato
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(contact)
        });
        const result = await response.json();
        // Log para depuração
        console.log('Resposta do salvamento:', result);
        // Verifica se o salvamento foi bem-sucedido
        if (result.success) {
          // Exibe mensagem de sucesso, atualiza a tabela e fecha o modal
          alert(id ? 'Contato atualizado' : 'Contato adicionado');
          loadContacts();
          bootstrap.Modal.getInstance(document.getElementById('contactModal')).hide();
          document.getElementById('contactForm').reset();
          document.getElementById('contactId').value = '';
          document.getElementById('contactModalLabel').textContent = 'Adicionar Contato';
        } else {
          // Exibe mensagem de erro
          alert(result.message);
        }
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro ao salvar contato:', e.message);
        alert('Erro ao salvar contato');
      }
    });

    // Função para carregar relatórios (admin)
    async function loadReports() {
      try {
        // Log para depuração
        console.log('Carregando relatórios...');
        // Envia solicitação para obter os relatórios
        const response = await fetch('/api/reports', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const reports = await response.json();
        // Log para depuração
        console.log('Relatórios carregados:', reports);
        // Seleciona o contêiner de relatórios
        const content = document.getElementById('reportsContent');
        // Preenche o contêiner com os dados dos relatórios
        content.innerHTML = `
          <h5>Contatos por Categoria</h5>
          <ul>
            ${Object.entries(reports.category).map(([cat, count]) => `<li>${cat}: ${count}</li>`).join('')}
          </ul>
          <h5>Contatos Ativos vs Inativos</h5>
          <p>Ativos: ${reports.active.active}, Inativos: ${reports.active.inactive}</p>
          <h5>Atualizações Recentes</h5>
          <ul>
            ${reports.updates.map(u => `<li>${u.name} - ${new Date(u.updatedAt).toLocaleString()}</li>`).join('')}
          </ul>
          <h5>Datas Especiais</h5>
          <ul>
            ${reports.specialDates.map(d => `<li>${d.name} - ${d.specialDate}</li>`).join('')}
          </ul>
          <h5>Frequência de Interação</h5>
          <ul>
            ${reports.interactions.map(i => `<li>${i.name}: ${i.count} interações</li>`).join('')}
          </ul>
          <h5>Crescimento da Base</h5>
          <ul>
            ${reports.growth.map(g => `<li>${g.month}: ${g.count} contatos</li>`).join('')}
          </ul>
          <h5>Falhas de Contato</h5>
          <ul>
            ${reports.failures.map(f => `<li>${f.name}: ${f.issue}</li>`).join('')}
          </ul>
        `;
      } catch (e) {
        // Log e mensagem de erro para falhas de conexão
        console.error('Erro ao carregar relatórios:', e.message);
        alert('Erro ao carregar relatórios. Verifique se o servidor está rodando.');
      }
    }
  </script>
</body>
</html>