<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda de Contatos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/estilo.css">
  <style>
    .login-container { max-width: 400px; margin: 0 auto; }
    .dashboard-container { display: none; }
    .alert { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    .report-table { margin-top: 20px; }
    .chat-container { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
    .chat-message { margin: 10px; padding: 10px; border-radius: 10px; max-width: 70%; }
    .chat-message.user { background: #007bff; color: white; margin-left: auto; }
    .chat-message.bot { background: #e9ecef; color: black; margin-right: auto; }
    .chat-message.admin { background: #28a745; color: white; margin-right: auto; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Agenda de Contatos</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="/index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()">Sair</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div id="loginSection" class="login-container">
      <h2>Login</h2>
      <div id="loginError" class="alert alert-danger d-none"></div>
      <div id="loginSuccess" class="alert alert-success d-none"></div>
      <form id="loginForm" class="mb-3">
        <div class="mb-3">
          <label for="loginUsername" class="form-label">Username</label>
          <input type="text" class="form-control" id="loginUsername" required>
        </div>
        <div class="mb-3">
          <label for="loginPassword" class="form-label">Senha</label>
          <input type="password" class="form-control" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Entrar</button>
      </form>
      <p class="text-center mt-3">Não tem conta? <a href="#" onclick="showRegister()">Registre-se</a></p>
    </div>

    <div id="registerSection" class="login-container d-none">
      <h2>Registrar</h2>
      <div id="registerError" class="alert alert-danger d-none"></div>
      <div id="registerSuccess" class="alert alert-success d-none"></div>
      <form id="registerForm" class="mb-3">
        <div class="mb-3">
          <label for="registerUsername" class="form-label">Username</label>
          <input type="text" class="form-control" id="registerUsername" required>
        </div>
        <div class="mb-3">
          <label for="registerPassword" class="form-label">Senha</label>
          <input type="password" class="form-control" id="registerPassword" required>
        </div>
        <div class="mb-3">
          <label for="registerEmail" class="form-label">E-mail</label>
          <input type="email" class="form-control" id="registerEmail">
        </div>
        <div class="mb-3">
          <label for="registerRole" class="form-label">Tipo de Conta</label>
          <select class="form-select" id="registerRole">
            <option value="user">Usuário</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary w-100">Registrar</button>
        <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLogin()">Voltar ao Login</button>
      </form>
    </div>

    <div id="dashboardSection" class="dashboard-container">
      <h2>Dashboard</h2>
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="showTab('contactsTab')">Contatos</a>
        </li>
        <li class="nav-item" id="usersTabNav" style="display: none;">
          <a class="nav-link" href="#" onclick="showTab('usersTab')">Gerenciar Usuários</a>
        </li>
        <li class="nav-item" id="reportsTabNav" style="display: none;">
          <a class="nav-link" href="#" onclick="showTab('reportsTab')">Relatórios</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showTab('chatTab')">Chat</a>
        </li>
      </ul>

      <div id="contactsTab" class="mt-3">
        <h3>Gerenciar Contatos</h3>
        <form id="contactForm" class="mb-3">
          <div class="row">
            <div class="col-md-3 mb-3">
              <input type="text" class="form-control" id="contactName" placeholder="Nome" required>
            </div>
            <div class="col-md-3 mb-3">
              <input type="text" class="form-control" id="contactPhone" placeholder="Telefone" required>
            </div>
            <div class="col-md-3 mb-3">
              <input type="email" class="form-control" id="contactEmail" placeholder="E-mail">
            </div>
            <div class="col-md-3 mb-3">
              <input type="text" class="form-control" id="contactCategory" placeholder="Categoria">
            </div>
            <div class="col-md-3 mb-3">
              <input type="date" class="form-control" id="contactBirthday" placeholder="Aniversário">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Adicionar Contato</button>
        </form>
        <h4>Lista de Contatos</h4>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Telefone</th>
              <th>E-mail</th>
              <th>Categoria</th>
              <th>Aniversário</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="contactList"></tbody>
        </table>
      </div>

      <div id="usersTab" class="mt-3 d-none">
        <h3>Gerenciar Usuários</h3>
        <form id="userForm" class="mb-3">
          <div class="row">
            <div class="col-md-3 mb-3">
              <input type="text" class="form-control" id="userUsername" placeholder="Username" required>
            </div>
            <div class="col-md-3 mb-3">
              <input type="password" class="form-control" id="userPassword" placeholder="Senha" required>
            </div>
            <div class="col-md-3 mb-3">
              <input type="email" class="form-control" id="userEmail" placeholder="E-mail">
            </div>
            <div class="col-md-3 mb-3">
              <select class="form-select" id="userRole">
                <option value="user">Usuário</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Adicionar Usuário</button>
        </form>
        <h4>Lista de Usuários</h4>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Username</th>
              <th>E-mail</th>
              <th>Papel</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="userList"></tbody>
        </table>
      </div>

      <div id="reportsTab" class="mt-3 d-none">
        <h3>Relatórios</h3>
        <div id="reportError" class="alert alert-danger d-none"></div>
        <ul class="list-group mb-3">
          <li class="list-group-item"><a href="#" onclick="loadReport('category')">Contatos por Categoria</a></li>
          <li class="list-group-item"><a href="#" onclick="loadReport('active-inactive')">Contatos Ativos vs. Inativos</a></li>
          <li class="list-group-item"><a href="#" onclick="loadReport('recent-updates')">Atualizações Recentes</a></li>
          <li class="list-group-item"><a href="#" onclick="loadReport('birthdays')">Aniversários</a></li>
          <li class="list-group-item"><a href="#" onclick="loadReport('interaction-frequency')">Frequência de Interação</a></li>
          <li class="list-group-item"><a href="#" onclick="loadReport('growth')">Crescimento da Base</a></li>
          <li class="list-group-item"><a href="#" onclick="loadReport('contact-failures')">Falhas de Contato</a></li>
        </ul>
        <div id="reportContent"></div>
      </div>

      <div id="chatTab" class="mt-3 d-none">
        <h3>Chat de Suporte</h3>
        <div id="chatMessages" class="chat-container"></div>
        <form id="chatForm" class="mt-3">
          <div class="input-group">
            <input type="text" class="form-control" id="chatInput" placeholder="Digite sua pergunta..." required>
            <button type="submit" class="btn btn-primary">Enviar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    console.log('Inicializando página...');

    let ws = null;
    function connectWebSocket() {
      ws = new WebSocket('ws://localhost:3000');
      ws.onopen = () => console.log('WebSocket conectado');
      ws.onmessage = (event) => {
        console.log('Mensagem recebida do WebSocket:', event.data);
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        const adminMessage = { sender: 'admin', text: event.data };
        chatHistory.push(adminMessage);
        const chatMessages = document.getElementById('chatMessages');
        const adminDiv = document.createElement('div');
        adminDiv.className = 'chat-message admin';
        adminDiv.textContent = event.data;
        chatMessages.appendChild(adminDiv);
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };
      ws.onclose = () => console.log('WebSocket desconectado');
      ws.onerror = (error) => console.error('Erro no WebSocket:', error);
    }

    function showRegister() {
      console.log('Exibindo seção de registro');
      document.getElementById('loginSection').classList.add('d-none');
      document.getElementById('registerSection').classList.remove('d-none');
      document.getElementById('dashboardSection').classList.add('d-none');
      clearMessages();
    }

    function showLogin() {
      console.log('Exibindo seção de login');
      document.getElementById('loginSection').classList.remove('d-none');
      document.getElementById('registerSection').classList.add('d-none');
      document.getElementById('dashboardSection').classList.add('d-none');
      clearMessages();
    }

    function showDashboard() {
      console.log('Exibindo dashboard');
      document.getElementById('loginSection').classList.add('d-none');
      document.getElementById('registerSection').classList.add('d-none');
      const dashboardSection = document.getElementById('dashboardSection');
      dashboardSection.style.display = 'block';
      dashboardSection.classList.remove('d-none');
      const isAdmin = localStorage.getItem('role') === 'admin';
      console.log('Usuário é admin?', isAdmin);
      document.getElementById('usersTabNav').style.display = isAdmin ? 'block' : 'none';
      document.getElementById('reportsTabNav').style.display = isAdmin ? 'block' : 'none';
      clearMessages();
      showTab('contactsTab');
      loadContacts();
      connectWebSocket();
    }

    function showTab(tabId) {
      console.log('Exibindo aba:', tabId);
      document.querySelectorAll('#dashboardSection > div').forEach(div => div.classList.add('d-none'));
      document.getElementById(tabId).classList.remove('d-none');
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      document.querySelector(`a[href="#"][onclick="showTab('${tabId}')"]`).classList.add('active');
      if (tabId === 'contactsTab') loadContacts();
      if (tabId === 'usersTab') loadUsers();
      if (tabId === 'chatTab') loadChat();
    }

    function clearMessages() {
      console.log('Limpando mensagens');
      ['loginError', 'loginSuccess', 'registerError', 'registerSuccess', 'reportError'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.classList.add('d-none');
          element.textContent = '';
        }
      });
    }

    function showMessage(section, type, message) {
      console.log(`Exibindo mensagem: ${section}${type} - ${message}`);
      const element = document.getElementById(`${section}${type}`);
      if (element) {
        element.textContent = message;
        element.classList.remove('d-none');
        setTimeout(() => element.classList.add('d-none'), 5000);
      }
    }

    async function logout() {
      console.log('Iniciando logout');
      try {
        const response = await fetch('/api/logout', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        localStorage.removeItem('username');
        localStorage.removeItem('role');
        localStorage.removeItem('chatCount');
        localStorage.removeItem('chatHistory');
        localStorage.removeItem('welcomeSent');
        if (ws) ws.close();
        showLogin();
        showMessage('login', 'Success', data.message || 'Logout bem-sucedido');
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        localStorage.removeItem('username');
        localStorage.removeItem('role');
        localStorage.removeItem('chatCount');
        localStorage.removeItem('chatHistory');
        localStorage.removeItem('welcomeSent');
        if (ws) ws.close();
        showLogin();
        showMessage('login', 'Success', 'Logout bem-sucedido');
      }
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      console.log('Tentando login com:', { username });
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        console.log('Resposta do login recebida:', response.status);
        const data = await response.json();
        console.log('Dados do login:', data);
        if (!response.ok) {
          console.warn('Login falhou:', data.error);
          showMessage('login', 'Error', data.error || 'Erro ao fazer login');
          return;
        }
        localStorage.setItem('username', data.username);
        localStorage.setItem('role', data.role);
        localStorage.setItem('chatCount', '0');
        localStorage.setItem('chatHistory', JSON.stringify([]));
        localStorage.setItem('welcomeSent', 'false');
        console.log('localStorage atualizado:', { username: data.username, role: data.role });
        showDashboard();
        showMessage('login', 'Success', data.message || 'Login bem-sucedido');
        document.getElementById('loginForm').reset();
      } catch (error) {
        console.error('Erro na requisição de login:', error);
        showMessage('login', 'Error', 'Erro de conexão com o servidor');
      }
    });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      const email = document.getElementById('registerEmail').value;
      const role = document.getElementById('registerRole').value;
      console.log('Tentando registrar:', { username, email, role });
      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, email, role })
        });
        const data = await response.json();
        console.log('Resposta do registro:', data);
        if (!response.ok) {
          console.warn('Registro falhou:', data.error);
          showMessage('register', 'Error', data.error || 'Erro ao registrar');
          return;
        }
        showLogin();
        showMessage('login', 'Success', data.message || 'Registro bem-sucedido! Faça login.');
        document.getElementById('registerForm').reset();
      } catch (error) {
        console.error('Erro na requisição de registro:', error);
        showMessage('register', 'Error', 'Erro de conexão com o servidor');
      }
    });

    async function loadContacts() {
      const username = localStorage.getItem('username');
      console.log('Carregando contatos para:', username);
      if (!username) {
        console.warn('Nenhum usuário logado');
        showMessage('login', 'Error', 'Você precisa estar logado para visualizar contatos');
        showLogin();
        return;
      }
      try {
        const response = await fetch('/api/contacts', {
          headers: { 'x-username': username }
        });
        console.log('Resposta de contatos:', response.status);
        const contacts = await response.json();
        console.log('Contatos carregados:', contacts);
        const contactList = document.getElementById('contactList');
        contactList.innerHTML = '';
        contacts.forEach(contact => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${contact.name}</td>
            <td>${contact.phone}</td>
            <td>${contact.email}</td>
            <td>${contact.category}</td>
            <td>${contact.birthday}</td>
            <td>
              <button class="btn btn-primary btn-sm me-1" onclick="interactContact('${contact.id}')">Interagir</button>
              <button class="btn btn-danger btn-sm" onclick="deleteContact('${contact.id}')">Excluir</button>
            </td>
          `;
          contactList.appendChild(row);
        });
      } catch (error) {
        console.error('Erro ao carregar contatos:', error);
        showMessage('login', 'Error', 'Erro ao carregar contatos');
      }
    }

    async function interactContact(id) {
      const username = localStorage.getItem('username');
      console.log('Registrando interação para contato:', id);
      try {
        const response = await fetch(`/api/contacts/${id}/interact`, {
          method: 'POST',
          headers: { 'x-username': username }
        });
        const data = await response.json();
        console.log('Resposta da interação:', data);
        if (response.ok) {
          showMessage('login', 'Success', data.message || 'Interação registrada');
          loadContacts();
        } else {
          console.warn('Falha na interação:', data.error);
          showMessage('login', 'Error', data.error || 'Erro ao registrar interação');
        }
      } catch (error) {
        console.error('Erro ao registrar interação:', error);
        showMessage('login', 'Error', 'Erro de conexão com o servidor');
      }
    }

    async function deleteContact(id) {
      const username = localStorage.getItem('username');
      console.log('Excluindo contato:', id);
      try {
        const response = await fetch(`/api/contacts/${id}`, {
          method: 'DELETE',
          headers: { 'x-username': username }
        });
        console.log('Resposta da exclusão:', response.status);
        if (response.ok) {
          loadContacts();
        } else {
          const data = await response.json();
          console.warn('Falha na exclusão:', data.error);
          showMessage('login', 'Error', data.error || 'Erro ao excluir contato');
        }
      } catch (error) {
        console.error('Erro ao excluir contato:', error);
        showMessage('login', 'Error', 'Erro de conexão com o servidor');
      }
    }

    document.getElementById('contactForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = localStorage.getItem('username');
      console.log('Adicionando contato para:', username);
      if (!username) {
        console.warn('Nenhum usuário logado');
        showMessage('login', 'Error', 'Você precisa estar logado para adicionar contatos');
        showLogin();
        return;
      }
      const contact = {
        name: document.getElementById('contactName').value,
        phone: document.getElementById('contactPhone').value,
        email: document.getElementById('contactEmail').value,
        category: document.getElementById('contactCategory').value,
        birthday: document.getElementById('contactBirthday').value
      };
      try {
        const response = await fetch('/api/contacts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-username': username
          },
          body: JSON.stringify(contact)
        });
        const data = await response.json();
        console.log('Resposta ao adicionar contato:', data);
        if (!response.ok) {
          console.warn('Falha ao adicionar contato:', data.error);
          showMessage('login', 'Error', data.error || 'Erro ao adicionar contato');
          return;
        }
        document.getElementById('contactForm').reset();
        loadContacts();
      } catch (error) {
        console.error('Erro ao adicionar contato:', error);
        showMessage('login', 'Error', 'Erro de conexão com o servidor');
      }
    });

    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = localStorage.getItem('username');
      console.log('Adicionando usuário por:', username);
      if (!username) {
        console.warn('Nenhum usuário logado');
        showMessage('login', 'Error', 'Você precisa estar logado para adicionar usuários');
        showLogin();
        return;
      }
      const user = {
        username: document.getElementById('userUsername').value,
        password: document.getElementById('userPassword').value,
        email: document.getElementById('userEmail').value,
        role: document.getElementById('userRole').value
      };
      try {
        const response = await fetch('/api/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-username': username
          },
          body: JSON.stringify(user)
        });
        const data = await response.json();
        console.log('Resposta ao adicionar usuário:', data);
        if (!response.ok) {
          console.warn('Falha ao adicionar usuário:', data.error);
          showMessage('login', 'Error', data.error || 'Erro ao adicionar usuário');
          return;
        }
        document.getElementById('userForm').reset();
        loadUsers();
      } catch (error) {
        console.error('Erro ao adicionar usuário:', error);
        showMessage('login', 'Error', 'Erro de conexão com o servidor');
      }
    });

    async function loadUsers() {
      const username = localStorage.getItem('username');
      console.log('Carregando usuários para:', username);
      if (!username) {
        console.warn('Nenhum usuário logado');
        return;
      }
      try {
        const response = await fetch('/api/users', {
          headers: { 'x-username': username }
        });
        console.log('Resposta de usuários:', response.status);
        const users = await response.json();
        console.log('Usuários carregados:', users);
        const userList = document.getElementById('userList');
        userList.innerHTML = '';
        users.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')">Excluir</button></td>
          `;
          userList.appendChild(row);
        });
      } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        showMessage('login', 'Error', 'Erro ao carregar usuários');
      }
    }

    async function deleteUser(username) {
      const currentUser = localStorage.getItem('username');
      console.log('Excluindo usuário:', username);
      try {
        const response = await fetch(`/api/users/${username}`, {
          method: 'DELETE',
          headers: { 'x-username': currentUser }
        });
        console.log('Resposta da exclusão de usuário:', response.status);
        if (response.ok) {
          loadUsers();
        } else {
          const data = await response.json();
          console.warn('Falha na exclusão de usuário:', data.error);
          showMessage('login', 'Error', data.error || 'Erro ao excluir usuário');
        }
      } catch (error) {
        console.error('Erro ao excluir usuário:', error);
        showMessage('login', 'Error', 'Erro de conexão com o servidor');
      }
    }

    async function loadReport(reportType) {
      const username = localStorage.getItem('username');
      const role = localStorage.getItem('role');
      console.log('Carregando relatório:', reportType);
      if (!username) {
        console.warn('Nenhum usuário logado');
        showMessage('report', 'Error', 'Você precisa estar logado para visualizar relatórios');
        showLogin();
        return;
      }
      if (role !== 'admin') {
        console.warn('Usuário não é admin');
        showMessage('report', 'Error', 'Apenas administradores podem visualizar relatórios');
        return;
      }
      try {
        const response = await fetch(`/api/reports/${reportType}`, {
          headers: { 'x-username': username }
        });
        console.log('Resposta do relatório:', response.status);
        const data = await response.json();
        console.log('Dados do relatório:', data);
        if (!response.ok) {
          console.warn('Falha ao carregar relatório:', data.error);
          showMessage('report', 'Error', data.error || 'Erro ao carregar relatório');
          return;
        }
        const reportContent = document.getElementById('reportContent');
        reportContent.innerHTML = '';

        if (reportType === 'category') {
          const table = document.createElement('table');
          table.className = 'table table-striped report-table';
          table.innerHTML = `
            <thead><tr><th>Categoria</th><th>Quantidade</th></tr></thead>
            <tbody>${data.map(row => `<tr><td>${row.category || 'Sem categoria'}</td><td>${row.count}</td></tr>`).join('')}</tbody>
          `;
          reportContent.appendChild(table);
        } else if (reportType === 'active-inactive') {
          const table = document.createElement('table');
          table.className = 'table table-striped report-table';
          table.innerHTML = `
            <thead><tr><th>Status</th><th>Quantidade</th></tr></thead>
            <tbody>
              <tr><td>Ativos</td><td>${data.active}</td></tr>
              <tr><td>Inativos</td><td>${data.inactive}</td></tr>
            </tbody>
          `;
          reportContent.appendChild(table);
        } else if (reportType === 'recent-updates') {
          const table = document.createElement('table');
          table.className = 'table table-striped report-table';
          table.innerHTML = `
            <thead><tr><th>Nome</th><th>Data de Atualização</th></tr></thead>
            <tbody>${data.map(row => `<tr><td>${row.name}</td><td>${new Date(row.updatedAt).toLocaleString()}</td></tr>`).join('')}</tbody>
          `;
          reportContent.appendChild(table);
        } else if (reportType === 'birthdays') {
          const table = document.createElement('table');
          table.className = 'table table-striped report-table';
          table.innerHTML = `
            <thead><tr><th>Nome</th><th>Data</th><th>Tipo</th></tr></thead>
            <tbody>${data.map(row => `<tr><td>${row.name}</td><td>${row.date}</td><td>${row.type}</td></tr>`).join('')}</tbody>
          `;
          reportContent.appendChild(table);
        } else if (reportType === 'interaction-frequency') {
          const table = document.createElement('table');
          table.className = 'table table-striped report-table';
          table.innerHTML = `
            <thead><tr><th>Nome</th><th>Interações</th></tr></thead>
            <tbody>${data.map(row => `<tr><td>${row.name}</td><td>${row.interactions}</td></tr>`).join('')}</tbody>
          `;
          reportContent.appendChild(table);
        } else if (reportType === 'growth') {
          const table = document.createElement('table');
          table.className = 'table table-striped report-table';
          table.innerHTML = `
            <thead><tr><th>Mês</th><th>Quantidade</th></tr></thead>
            <tbody>${data.map(row => `<tr><td>${row.month}</td><td>${row.count}</td></tr>`).join('')}</tbody>
          `;
          reportContent.appendChild(table);
        } else if (reportType === 'contact-failures') {
          const table = document.createElement('table');
          table.className = 'table table-striped report-table';
          table.innerHTML = `
            <thead><tr><th>Nome</th><th>Telefone</th><th>E-mail</th><th>Problemas</th></tr></thead>
            <tbody>${data.map(row => `<tr><td>${row.name}</td><td>${row.phone}</td><td>${row.email}</td><td>${row.issues.join(', ')}</td></tr>`).join('')}</tbody>
          `;
          reportContent.appendChild(table);
        }
      } catch (error) {
        console.error('Erro ao carregar relatório:', error);
        showMessage('report', 'Error', 'Erro de conexão com o servidor');
      }
    }

    // Chatbot Logic
    function loadChat() {
      console.log('Carregando chat');
      const username = localStorage.getItem('username');
      if (!username) {
        console.warn('Nenhum usuário logado');
        showMessage('login', 'Error', 'Você precisa estar logado para acessar o chat');
        showLogin();
        return;
      }
      const chatMessages = document.getElementById('chatMessages');
      let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      let welcomeSent = localStorage.getItem('welcomeSent') === 'true';
      if (!welcomeSent) {
        const welcomeMessage = {
          sender: 'bot',
          text: 'Bem-vindo ao suporte da Agenda de Contatos! Como posso ajudar? (Limite: 5 perguntas)'
        };
        chatHistory.push(welcomeMessage);
        localStorage.setItem('welcomeSent', 'true');
      }
      chatMessages.innerHTML = '';
      chatHistory.forEach(msg => {
        const div = document.createElement('div');
        div.className = `chat-message ${msg.sender}`;
        div.textContent = msg.text;
        chatMessages.appendChild(div);
      });
      const chatCount = parseInt(localStorage.getItem('chatCount') || '0');
      if (chatCount >= 5) {
        document.getElementById('chatInput').disabled = true;
        document.getElementById('chatInput').placeholder = 'Aguardando resposta do administrador...';
        const limitMessage = {
          sender: 'bot',
          text: 'Limite de perguntas atingido. Um administrador responderá em breve.'
        };
        if (!chatHistory.some(msg => msg.text === limitMessage.text)) {
          chatHistory.push(limitMessage);
          const limitDiv = document.createElement('div');
          limitDiv.className = 'chat-message bot';
          limitDiv.textContent = limitMessage.text;
          chatMessages.appendChild(limitDiv);
        }
      }
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function getBotResponse(question) {
      console.log('Processando pergunta:', question);
      const lowerQuestion = question.toLowerCase();
      if (lowerQuestion.includes('adicionar contato') || lowerQuestion.includes('novo contato')) {
        return 'Para adicionar um contato, vá para a aba "Contatos", preencha os campos (nome, telefone, etc.) no formulário e clique em "Adicionar Contato".';
      } else if (lowerQuestion.includes('quem sou') || lowerQuestion.includes('quem é')) {
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('role');
        return `Você é ${username}, com papel ${role === 'admin' ? 'Administrador' : 'Usuário'}.`;
      } else if (lowerQuestion.includes('relatórios') || lowerQuestion.includes('acessar relatório')) {
        return localStorage.getItem('role') === 'admin'
          ? 'Para acessar relatórios, vá para a aba "Relatórios" e clique em um dos links, como "Contatos por Categoria".'
          : 'Apenas administradores podem acessar relatórios. Contate um admin.';
      } else if (lowerQuestion.includes('data de hoje') || lowerQuestion.includes('que dia')) {
        return 'Hoje é 14 de maio de 2025.';
      } else if (lowerQuestion.includes('este sistema') || lowerQuestion.includes('o que faz')) {
        return 'Este é um sistema de Agenda de Contatos para gerenciar contatos, com funcionalidades como adicionar, excluir, interagir com contatos e gerar relatórios (para admins).';
      } else {
        return 'Desculpe, não entendi. Tente algo como "Como adicionar um contato?" ou "Quem sou eu?".';
      }
    }

    document.getElementById('chatForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const chatInput = document.getElementById('chatInput');
      const question = chatInput.value.trim();
      if (!question) return;

      let chatCount = parseInt(localStorage.getItem('chatCount') || '0');
      let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      const chatMessages = document.getElementById('chatMessages');
      const username = localStorage.getItem('username');

      // Adicionar mensagem do usuário
      const userMessage = { sender: 'user', text: question };
      chatHistory.push(userMessage);
      const userDiv = document.createElement('div');
      userDiv.className = 'chat-message user';
      userDiv.textContent = question;
      chatMessages.appendChild(userDiv);

      // Processar resposta
      if (chatCount < 5) {
        chatCount++;
        localStorage.setItem('chatCount', chatCount.toString());
        const botResponse = getBotResponse(question);
        const botMessage = { sender: 'bot', text: botResponse };
        chatHistory.push(botMessage);
        const botDiv = document.createElement('div');
        botDiv.className = 'chat-message bot';
        botDiv.textContent = botResponse;
        chatMessages.appendChild(botDiv);
        if (chatCount === 5) {
          const limitMessage = { sender: 'bot', text: 'Limite de perguntas atingido. Um administrador responderá em breve.' };
          chatHistory.push(limitMessage);
          const limitDiv = document.createElement('div');
          limitDiv.className = 'chat-message bot';
          limitDiv.textContent = limitMessage.text;
          chatMessages.appendChild(limitDiv);
          document.getElementById('chatInput').disabled = true;
          document.getElementById('chatInput').placeholder = 'Aguardando resposta do administrador...';
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ user: username, message: question }));
          }
        }
      } else {
        console.log('Mensagem para admin:', { user: username, message: question });
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ user: username, message: question }));
        }
        return; // Não permitir novas mensagens do usuário
      }

      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      chatMessages.scrollTop = chatMessages.scrollHeight;
      chatInput.value = '';
    });

    // Inicializar página
    console.log('Verificando estado inicial');
    const username = localStorage.getItem('username');
    const role = localStorage.getItem('role');
    console.log('Estado do localStorage:', { username, role });
    if (username && role) {
      console.log('Usuário logado detectado, exibindo dashboard');
      showDashboard();
    } else {
      console.log('Nenhum usuário logado, exibindo login');
      showLogin();
    }
  </script>
</body>
</html>