<!DOCTYPE html>
     <html lang="pt-BR">
     <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>Agenda de Contatos - Contatos</title>
       <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
       <link rel="stylesheet" href="estilo.css">
     </head>
     <body>
       <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
         <div class="container-fluid">
           <a class="navbar-brand" href="#">Agenda de Contatos</a>
           <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
             <span class="navbar-toggler-icon"></span>
           </button>
           <div class="collapse navbar-collapse" id="navbarNav">
             <ul class="navbar-nav me-auto">
               <li class="nav-item">
                 <a class="nav-link" href="index.html">Home</a>
               </li>
               <li class="nav-item">
                 <a class="nav-link active" href="contacts.html">Contatos</a>
               </li>
               <li class="nav-item">
                 <a class="nav-link" href="tasks.html">Tarefas</a>
               </li>
               <li class="nav-item">
                 <a class="nav-link" href="chat.html">Chat</a>
               </li>
               <li class="nav-item dropdown" id="reports-nav" style="display: none;">
                 <a class="nav-link dropdown-toggle" href="#" id="reportsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                   Relatórios
                 </a>
                 <ul class="dropdown-menu" aria-labelledby="reportsDropdown">
                   <li><a class="dropdown-item" href="index.html" onclick="loadReport('category')">Contatos por Categoria</a></li>
                   <li><a class="dropdown-item" href="index.html" onclick="loadReport('active')">Contatos Ativos vs. Inativos</a></li>
                   <li><a class="dropdown-item" href="index.html" onclick="loadReport('updates')">Atualizações Recentes</a></li>
                   <li><a class="dropdown-item" href="index.html" onclick="loadReport('birthdays')">Aniversários de Contatos</a></li>
                   <li><a class="dropdown-item" href="index.html" onclick="loadReport('frequency')">Frequência de Interação</a></li>
                   <li><a class="dropdown-item" href="index.html" onclick="loadReport('growth')">Crescimento da Base</a></li>
                   <li><a class="dropdown-item" href="index.html" onclick="loadReport('failures')">Falhas de Contato</a></li>
                 </ul>
               </li>
             </ul>
             <span class="navbar-text me-3" id="welcome-message"></span>
             <ul class="navbar-nav">
               <li class="nav-item">
                 <a class="nav-link" href="#" onclick="logout()">Sair</a>
               </li>
             </ul>
           </div>
         </div>
       </nav>

       <div class="container mt-4">
         <h3>Lista de Contatos</h3>
         <table class="table table-striped">
           <thead>
             <tr>
               <th>Nome</th>
               <th>Telefone</th>
               <th>E-mail</th>
               <th>Categoria</th>
               <th>Ações</th>
             </tr>
           </thead>
           <tbody id="contact-list"></tbody>
         </table>
       </div>

       <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
         <div class="modal-dialog">
           <div class="modal-content">
             <div class="modal-header">
               <h5 class="modal-title" id="editModalLabel">Editar Contato</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
             <div class="modal-body">
               <form id="edit-contact-form">
                 <input type="hidden" id="edit-id">
                 <div class="mb-3">
                   <label for="edit-name" class="form-label">Nome</label>
                   <input type="text" class="form-control" id="edit-name" required>
                 </div>
                 <div class="mb-3">
                   <label for="edit-phone" class="form-label">Telefone</label>
                   <input type="text" class="form-control" id="edit-phone" required>
                 </div>
                 <div class="mb-3">
                   <label for="edit-email" class="form-label">E-mail</label>
                   <input type="email" class="form-control" id="edit-email">
                 </div>
                 <div class="mb-3">
                   <label for="edit-category" class="form-label">Categoria</label>
                   <select class="form-control" id="edit-category">
                     <option value="Família">Família</option>
                     <option value="Trabalho">Trabalho</option>
                     <option value="Amigos">Amigos</option>
                     <option value="Clientes">Clientes</option>
                   </select>
                 </div>
                 <div class="mb-3">
                   <label for="edit-birthday" class="form-label">Aniversário</label>
                   <input type="date" class="form-control" id="edit-birthday">
                 </div>
                 <button type="submit" class="btn btn-primary">Salvar</button>
               </form>
             </div>
           </div>
         </div>
       </div>

       <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
       <script>
         // Função para validar telefone no frontend
         function isValidPhone(phone) {
           if (!phone) return false;
           const cleanedPhone = phone.replace(/[^0-9+]/g, '');
           const regex = /^(?:\+258\d{9}|\d{9})$/;
           return regex.test(cleanedPhone);
         }

         // Função para validar e-mail no frontend
         function isValidEmail(email) {
           if (!email) return true; // E-mail é opcional
           return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
         }

         // Verifica login e exibe boas-vindas
         console.log('Verificando sessão do usuário');
         const user = JSON.parse(sessionStorage.getItem('user'));
         if (!user || !user.username) {
           console.log('Usuário não autenticado, redirecionando para index.html');
           window.location.href = 'index.html';
           return;
         }

         console.log('Usuário autenticado:', user.username);
         document.getElementById('welcome-message').textContent = `Bem-vindo, ${user.username}!`;
         if (user.role === 'admin') {
           document.getElementById('reports-nav').style.display = 'block';
         }

         // Função de logout
         function logout() {
           console.log('Executando logout');
           sessionStorage.clear();
           window.location.href = 'index.html';
           // Forçar recarregamento sem cache
           window.location.reload(true);
         }

         // Carregar contatos
         async function loadContacts() {
           try {
             console.log('Fazendo requisição para /api/contacts com usuário:', user.username);
             const response = await fetch('/api/contacts', {
               headers: { 'X-Username': user.username }
             });
             if (!response.ok) {
               throw new Error(`Erro ao carregar contatos: ${response.status}`);
             }
             const data = await response.json();
             const contactList = document.getElementById('contact-list');
             contactList.innerHTML = '';
             data.forEach(contact => {
               const issues = [];
               if (contact.email && !isValidEmail(contact.email)) issues.push('E-mail inválido');
               if (!isValidPhone(contact.phone)) issues.push('Telefone inválido');
               const canEdit = user.role === 'admin' || issues.length > 0;
               const row = document.createElement('tr');
               row.innerHTML = `
                 <td>${contact.name}</td>
                 <td>${contact.phone}</td>
                 <td>${contact.email || ''}</td>
                 <td>${contact.category}</td>
                 <td>
                   ${canEdit ? `<button class="btn btn-sm btn-warning" onclick="editContact('${contact._id}')">Editar</button>` : ''}
                   ${user.role === 'admin' ? `<button class="btn btn-sm btn-danger" onclick="deleteContact('${contact._id}')">Excluir</button>` : ''}
                 </td>
               `;
               contactList.appendChild(row);
             });
           } catch (error) {
             console.error('Erro ao carregar contatos:', error);
             alert('Erro ao carregar contatos: ' + error.message);
           }
         }

         // Editar contato
         async function editContact(id) {
           try {
             const response = await fetch(`/api/contacts/${id}`, {
               headers: { 'X-Username': user.username }
             });
             if (!response.ok) {
               throw new Error('Contato não encontrado');
             }
             const contact = await response.json();
             document.getElementById('edit-id').value = contact._id;
             document.getElementById('edit-name').value = contact.name;
             document.getElementById('edit-phone').value = contact.phone;
             document.getElementById('edit-email').value = contact.email || '';
             document.getElementById('edit-category').value = contact.category;
             document.getElementById('edit-birthday').value = contact.birthday || '';
             new bootstrap.Modal(document.getElementById('editModal')).show();
           } catch (error) {
             alert('Erro ao carregar contato: ' + error.message);
           }
         }

         document.getElementById('edit-contact-form').addEventListener('submit', async (event) => {
           event.preventDefault();
           const phone = document.getElementById('edit-phone').value;
           const email = document.getElementById('edit-email').value;
           if (!isValidPhone(phone)) {
             alert('O número de telefone deve ter exatamente 9 dígitos ou começar com +258 seguido de 9 dígitos');
             return;
           }
           if (email && !isValidEmail(email)) {
             alert('E-mail inválido');
             return;
           }
           const id = document.getElementById('edit-id').value;
           const contact = {
             name: document.getElementById('edit-name').value,
             phone,
             email,
             category: document.getElementById('edit-category').value,
             birthday: document.getElementById('edit-birthday').value
           };
           try {
             const response = await fetch(`/api/contacts/${id}`, {
               method: 'PUT',
               headers: {
                 'Content-Type': 'application/json',
                 'X-Username': user.username
               },
               body: JSON.stringify(contact)
             });
             if (!response.ok) {
               const result = await response.json();
               throw new Error(result.error || 'Erro ao atualizar contato');
             }
             loadContacts();
             bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
             alert('Contato atualizado com sucesso!');
           } catch (error) {
             alert('Erro ao atualizar contato: ' + error.message);
           }
         });

         // Excluir contato
         async function deleteContact(id) {
           if (confirm('Tem certeza que deseja excluir este contato?')) {
             try {
               const response = await fetch(`/api/contacts/${id}`, {
                 method: 'DELETE',
                 headers: { 'X-Username': user.username }
               });
               if (!response.ok) {
                 throw new Error('Erro ao excluir contato');
               }
               loadContacts();
               alert('Contato excluído com sucesso!');
             } catch (error) {
               alert('Erro ao excluir contato: ' + error.message);
             }
           }
         }

         // Carregar contatos ao iniciar
         loadContacts();
       </script>
     </body>
     </html>